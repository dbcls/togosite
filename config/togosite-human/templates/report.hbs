<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<div id="reportBody"></div>
<script type="text/javascript">
  (() => {
    // Get row data from frontend table view
    // const data = {{data}};

    // For testing
    const data = {
      "id": "9666",
      "label": "PTPRC",
      "properties": [
        {
          "propertyId": "ensembl-gene-chromosome",
          "propertyLabel": "Chromosome",
          "propertyKey": "ensembl_gene",
          "attributes": [
            {
              "attribute": {
                "categoryId": "1",
                "label": "chr1",
                "uri": ""
              },
              "id": "ENSG00000081237"
            }
          ]
        },
        {
          "propertyId": "uniprot_keywords_domain",
          "propertyLabel": "Protein domains",
          "propertyKey": "uniprot",
          "attributes": [
            {
              "attribute": {
                "categoryId": "812",
                "label": "Transmembrane",
                "uri": "http://purl.uniprot.org/keywords/812"
              },
              "id": "P08575"
            },
            {
              "attribute": {
                "categoryId": "812",
                "label": "Transmembrane",
                "uri": "http://purl.uniprot.org/keywords/812"
              },
              "id": "A0A075B788"
            },
            {
              "attribute": {
                "categoryId": "812",
                "label": "Transmembrane",
                "uri": "http://purl.uniprot.org/keywords/812"
              },
              "id": "E9PKH0"
            },
            {
              "attribute": {
                "categoryId": "812",
                "label": "Transmembrane",
                "uri": "http://purl.uniprot.org/keywords/812"
              },
              "id": "M3ZCP1"
            }
          ]
        },
        {
          "propertyId": "chebi_reactome",
          "propertyLabel": "Compounds in pathway",
          "propertyKey": "chebi",
          "attributes": [
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "15765"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "17026"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "28940"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "17252"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "46195"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "27732"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "17154"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "41423"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "30769"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "35854"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16469"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "17858"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "17263"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "15882"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "2208"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "50673"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16870"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "8107"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "8050"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "2504"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "2453"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16359"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16330"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "28119"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "15367"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "17347"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "17650"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16914"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "45863"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "27385"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16796"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "18145"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "4470"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "28748"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "30746"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16236"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "15940"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "28794"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "28918"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "16240"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "57305"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "41774"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "6532"
            },
            {
              "attribute": {
                "categoryId": "R-HSA-1430728",
                "label": "Metabolism"
              },
              "id": "168396"
            }
          ]
        },
        {
          "propertyId": "disease_mondo_filter",
          "propertyLabel": "Diseases in Mondo",
          "propertyKey": "mondo",
          "attributes": [
            {
              "attribute": {
                "categoryId": "0021199",
                "label": "disease by anatomical system",
                "uri": "http://purl.obolibrary.org/obo/MONDO_0021199"
              },
              "id": "0012163"
            }
          ]
        }
      ]
    };

    // Functions
    // access API and return JSON
    const fetchJSON = async (api) => {
      const response = await fetch(api);
      const json = await response.json();
      // console.log(api);  // debug
      // console.log(json); // debug
      return json;
    }

    // configuration files
    const propertiesConfig = async () => {
      const propertiesConfigUrl = "https://raw.githubusercontent.com/dbcls/togosite/develop/config/togosite-human/properties.json";
      const config = await fetchJSON(propertiesConfigUrl);
      return config;
    }

    const templatesConfig = async () => {
      const templatesConfigUrl = "https://raw.githubusercontent.com/dbcls/togosite/develop/config/togosite-human/templates.json";
      const config = await fetchJSON(templatesConfigUrl);
      return config;
    }

    // dict to return subject for a given attribute id
    const subjectDict = async () => {
      const config = await propertiesConfig();
      const dict = {};
      for (const subject of config) {
        const subjectId = subject.subjectId;
        for (const prop of subject.properties) {
          const id = prop.propertyId;
          dict[id] = subjectId;
        }
      }
      return dict;
    }

    // Return deduplicated id list, e.g. [{id: xxx, key: uniprot, subject: protein}, {}, ...]
    const idList = async (row) => {
      const list = [];
      const dict = await subjectDict();

      const togokeyId = row.id;
      const togokeyLabel = row.label;
      // row should have togoKey type e.g. hgnc and togokey also should be in the list

      for (const prop of row.properties) {
        const propId = prop.propertyId;
        const propLabel = prop.propertyLabel;
        const propKey = prop.propertyKey;

        for (const attr of prop.attributes) {
          const attrId = attr.id;
          const attrLabel = attr.attribute.label;
          const attrUri = attr.attribute.uri;

          const entry = {
            'id': attrId,
            'key': propKey,
            'subject': dict[propId]
          };

          list.push(JSON.stringify(entry));
        }
      }

      // unique and return
      // const filtered = list.filter((elem, index, self) => self.indexOf(elem) === index);
      // return filtered;

      // another unique method: suitable for bigger array, too much overhead for small ones
      const uniqueArray = Array.from(new Set(list));
      return uniqueArray.map(x => JSON.parse(x));
    }

    // Get handlebars template
    const handlebarsTemplate = async (id, key, subject) => {
      const config = await templatesConfig();
      const url = config["templates"][subject]
      const response = await fetch(url);
      const text = await response.text();
      const template = Handlebars.compile(text);
      return template({ id: id, type: key }); // return html string compiled from template with params
    }

    // append string to element and enable script tag
    const appendString = async (str, node) => {
      node.innerHTML = str;
      node.querySelectorAll('script').forEach(scriptElement => {
          const _script = document.createElement('script');
          _script.textContent = scriptElement.textContent;
          scriptElement.replaceWith(_script);
      });
      return node;
    }

    // Append column information to the body
    const appendTemplate = async (id, key, subject) => {
      const divId = key + '_' + id;
      const div = document.getElementById(divId);

      const template = await handlebarsTemplate(id, key, subject);
      const templateDiv = await appendString(template, div)
    }

    // Create div for each ids
    const appendDiv = (id, key) => {
      const div = document.createElement('div');
      const divId = key + '_' + id;
      div.setAttribute('id', divId);

      const reportBody = document.getElementById("reportBody");
      reportBody.appendChild(div);
    }

    // Create script elements of metastanza external script
    const importMetastanzaScript = async () => {
      const reportBody = document.getElementById("reportBody");
      const config = await templatesConfig();
      for (const url of config["stanzas"]) {
        const script = document.createElement('script');
        script.src = url;
        script.type = 'module';
        script.async = true;
        reportBody.appendChild(script);
      }
    }

    // itearete each item to append hbs templates
    const main = async () => {
      importMetastanzaScript();
      const list = await idList(data);
      console.log(list);

      for (const d of list) {
        appendDiv(d.id, d.key);
      }

      for (const d of list) {
        appendTemplate(d.id, d.key, d.subject);
      }
    }

    main();
  })()
</script>
