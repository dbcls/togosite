{"version":3,"file":"report.js","sources":["../../source/js/classes/ReportApp.js","../../source/js/report.js"],"sourcesContent":["// import DefaultEventEmitter from \"./DefaultEventEmitter\";\n\nconst CONF_PROPERTIES = 'https://raw.githubusercontent.com/dbcls/togosite/develop/config/togosite-human/properties.json';\nconst CONF_TEMPLATES = 'https://raw.githubusercontent.com/dbcls/togosite/develop/config/togosite-human/templates.json';\nconst CONF_AGGREGATE = 'https://raw.githubusercontent.com/dbcls/togosite/develop/config/togosite-human/aggregate.json';\n\nclass ReportApp {\n\n  #subjects;\n  #templates;\n\n  constructor() {\n  }\n\n  ready() {\n\n    let stanzaTtemplates;\n    // load config json\n    Promise.all([\n      fetch(CONF_PROPERTIES),\n      fetch(CONF_TEMPLATES),\n      fetch(CONF_AGGREGATE)\n    ])\n      .then(responces => Promise.all(responces.map(responce => responce.json())))\n      .then(([subjects, templates, aggregate]) => {\n        console.log(subjects)\n        console.log(templates)\n        // console.log(aggregate)\n        stanzaTtemplates = templates;\n        this.#subjects = subjects;\n\n        // set stanza scripts\n        document.querySelector('head').insertAdjacentHTML('beforeend', templates.stanzas.map(stanza => `<script type=\"module\" src=\"${stanza}\"></script>`).join(''));\n\n        // get stanza templates\n        return Promise.all(\n          Object.keys(templates.templates).map(key => fetch(templates.templates[key]))\n        );\n      })\n      .then(responces => Promise.all(responces.map(responce => responce.text())))\n      .then(templates => {\n        console.log(templates)\n        this.#templates = Object.fromEntries(Object.keys(stanzaTtemplates.templates).map((stanza, index) => [stanza, templates[index]]));\n\n        this.#drawStanzas();\n      });\n  }\n\n  #drawStanzas() {\n    const urlVars = Object.fromEntries(window.location.search.substr(1).split('&').map(keyValue => keyValue.split('=')));\n    console.log( urlVars )\n    console.log( JSON.parse(decodeURIComponent(urlVars.properties)) )\n    const properties = JSON.parse(decodeURIComponent(urlVars.properties));\n    console.log(properties)\n    \n    const main = document.querySelector('main');\n    const subjectId = this.#subjects.find(subject => subject.togoKey === urlVars.togoKey).subjectId;\n    main.innerHTML =\n      this.#templates[subjectId].replace(/{{id}}/g, urlVars.id).replace(/{{type}}/g, urlVars.togoKey) +\n      properties.map(property => {\n        console.log(property)\n        if (property === undefined) {\n          return '';\n        } else {\n          const subject = this.#subjects.find(subject => subject.properties.some(subjectProperty => subjectProperty.propertyId === property.propertyId));\n          const template = this.#templates[subject.subjectId];\n          // TODO: 1個目のアトリビュートしか返していない\n          return '<hr>' + property.attributes.map(attribute => template.replace(/{{id}}/g, attribute.id).replace(/{{type}}/g, property.propertyKey)).join('');\n        }\n      }).join('');\n\n  }\n\n}\n\nexport default new ReportApp();\n","import ReportApp from './classes/ReportApp.js';\n\nglobalThis.togositeapp = ReportApp;\nReportApp.ready();\n"],"names":["CONF_PROPERTIES","CONF_TEMPLATES","CONF_AGGREGATE","ReportApp","stanzaTtemplates","Promise","all","fetch","then","responces","map","responce","json","subjects","templates","console","log","document","querySelector","insertAdjacentHTML","stanzas","stanza","join","Object","keys","key","text","fromEntries","index","urlVars","window","location","search","substr","split","keyValue","JSON","parse","decodeURIComponent","properties","main","subjectId","find","subject","togoKey","innerHTML","replace","id","property","undefined","some","subjectProperty","propertyId","template","attributes","attribute","propertyKey","globalThis","togositeapp","ready"],"mappings":"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"}